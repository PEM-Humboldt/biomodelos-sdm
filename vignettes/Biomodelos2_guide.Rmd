---
title: "Biomodelos 2: user guide"
author: "Carlos Jair Muñoz Rodriguez, Rafael Moreno Arias, Gabriel Alejandro Perilla Suarez, María Helena Olaya Rodríguez, Cristian Alexander Cruz Rodriguez,  Andrés Felipe Suárez Castro, Luis Hernando Romero Jiménez, Elkin Alexi Noguera Urbano"
date: "1/2/2021"
output: html_document
---

# Introduction

Biomodelos 2 is an effort to construct thousands of Species Distribution Models from databases gathered and managed by the Instituto de Investigacion de Recursos Biologicos Alexander von Humboldt (IAvH). Biomodelos 2 follows the SDM general routine. First, it cleans occurrence data and constructs the accessible area. Second, it crops and masks current and future environmental variables. Third, it creates SDM's using several machine learning algorithms and then ensembles them. Fourth, it projects to future scenarios and evaluates extrapolation.


# Setup

## Working directory

In order to work in R you need a working directory. There are two ways, manually and automatically. Manually, first, you need to create in your hard drive a folder and second, locate it inside the root of the hard drive. Third, set the folder created as your working directory. Automatically, using `dir.create()` function to create the folder inside the desired hard disk. In this case, we created a folder called **16kproyect** with the above mentioned function inside the disk C and then call it as de working directory.

```{r setup_wd, include=TRUE}
dir.create("C:/16kproyect", showWarnings = FALSE)

knitr::opts_knit$set(root.dir = "C:/16kproyect/" )
```

## Packages

To begin with you need to setup folders and install the packages needed for the process. So, please download the `setup.R` code from the Biomodelos 2 github repository and storage it inside the Working directory. Then call the setup R code.

```{r setup_source, include=TRUE}
source("setup.R",  local = knitr::knit_global())
```

The above code loads the next R objects:

*   character data
    +   `vector.packages`: needed packages.
*   functions 
    +   `do.install`: automatic installing of packages.
    +   `do.load`: automatic loading of packages.
    +   `do.folder.structure`: needed folder structure.
    
The packages are

```{r setup_pkg.list, include=T, message = T}
vector.packages
```


In case of first execution of script , please run `do.install`

```{r setup_pkg.installing, echo = T, message = F, include= T}
do.install(x= vector.packages)
```

If it is not the first time, please only run `do.load`

```{r setup_pkg.load, echo = T, message = F, include= T}
do.load(x = vector.packages)
```

### Kuenm installing

Kuenm can not install automatically from CRAN (the server of R packages). Also, it is a picky package that needs several dependencies installed. This process can be time consuming but not an overwhelming task. Follow the next process:

*   First, install [Rtools](https://cran.r-project.org/bin/windows/Rtools/)
*   Second, install Java Development Kit [JDK](https://oracle.com/java/technologies/javase/javase-jdk8-downloads.html)
*   Third, download [maxent](https://biodiversityinformatics.amnh.org/open_source/maxent/) and move it to Working directory root.

Then run the next code

```{r setup_pkg.kuenm, echo = T, message = F, include= T}
if (!require(kuenm)) {
  devtools::install_github("marlonecobos/kuenm")
}
```

For more information, please refer to [kuenm github repository](https://github.com/marlonecobos/kuenm).

## Folder structure

Biomodelos 2 creates a folder structure to make easier the process. The folder structure is built by the `do.folder.structure` function. The argument`clim.datasets` refers to the name of the climatic data set that will be used like Worldclim, Chelsa, EarthEnv, ENVIREM, etc. If you want to make some processing to the layers or data, please do it before locate them inside the folders.


```{r setup_folder.structure, echo = T, message = F, include= T}
do.folder.structure(clim.datasets = c("worldclim", "chelsa"))
```

The above function creates the next folders inside the Working directory:

*   R: folder to store Biomodelos 2 R files, please downloaded them from the repository. *.R files only*. (LINK) MISSING
*   bias_layer. Needed (?) MISSING
*   Data.
    +   biogeographic_shp: folder to store bio-geographic, ecoregions, and hydrosheets used to construct the accessible area by each species, *.shp or .tif files only*.
    +   env_vars: folder to store environmental variables, *.tif files only*.
        -   other: current and future folders.
        -   climatic: current and future folders.
    +   primary_occurrences: folder to store occurrence species data, it could be as downloaded from online repositories or given from other researchers, *.csv files only*.
    +   shapes: storage of useful shape files like Colombian or American borders, *.shp files only*. (needed ? MISSING)
    

After run the `do.folder.structure` function, you are ready to: download and locate climate data sets, occurrence databases, the Biomodelos 2 scripts, etc., each file in the respective folder. A very important folder is the one called *biogeographic_shp*. WHY (?) MISING

# Occurrence data set

## Set16

Biomodelos 2 is designed to work with the Set16 database of Colombian Biota. It is a big database gathered and managed by the IAvH. It was constructed from online repositories, museum specimens, expert registers, literature review, and so on. The Set16 data base has been object of several cleaning routines in which were found occurrences. Better description (MISSING).

Set16 stores geographic information of approximately 16.000 species. It is better to split the data set in smaller chunks to be used inside the `Bio2_routine.R` function each time. In this, we splitted the data beforehand depending on taxonomic orders and then in species.


```{r occ_data, echo = T, message = F, include= T, warning = F}
set16_df <- read.csv("Data/primary_occurrences/registros_primates_set16.csv",
  stringsAsFactors = FALSE, sep = ","
)

occ_list <- split(set16_df, f = set16_df$acceptedNameUsage)
```

The variables in the Set16 are the next:

```{r occ_data2, echo = F, message = F, include= T, warning = F}
colnames(set16_df)
```

### Compabilty

Mandatory variables are "acceptedNameUsage", "eventDate", "decimalLongitude", and "decimalLatitude" variables or similar like "speciesname", "date", "lon", and "lat". In this way, the Biomodelos 2 routine can be applied to whichever occurrence species data set with those variables, only make sure to change argument options in the `Bio2_routine.R`.


# Biomodelos 2 Routine

The core of Biomodelos 2 is the function `Bio2_routine.R`. 

```{r routine_source, include=TRUE}
source("R/Bio2_routine.R",  local = knitr::knit_global())
```

MISSING EXPLANATION OF ROUTINE, use the diagram chart drive